<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Регистрация</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .error {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
        .info {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .required:after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
<h2>Регистрация в мессенджере</h2>

<div id="message"></div>

<form id="registerForm">
    <div class="form-group">
        <label class="required">Логин:</label>
        <input type="text" id="login" required
               placeholder="example123"
               minlength="3" maxlength="50"
               pattern="[a-zA-Z0-9_]+">
        <div class="info">3-50 символов, только латиница, цифры и подчеркивание</div>
        <div class="error" id="loginError"></div>
    </div>

    <div class="form-group">
        <label>Имя пользователя:</label>
        <input type="text" id="username"
               placeholder="Иван Иванов"
               maxlength="100">
        <div class="info">Как вас будут видеть другие</div>
        <div class="error" id="usernameError"></div>
    </div>

    <div class="form-group">
        <label class="required">Номер телефона:</label>
        <input type="tel" id="phone" required
               placeholder="+79991234567">
        <div class="info">Международный формат: +79991234567</div>
        <div class="error" id="phoneError"></div>
    </div>

    <div class="form-group">
        <label>Email (необязательно):</label>
        <input type="email" id="email"
               placeholder="example@mail.com">
        <div class="error" id="emailError"></div>
    </div>

    <div class="form-group">
        <label class="required">Пароль:</label>
        <input type="password" id="password" required
               minlength="6">
        <div class="info">Не менее 6 символов</div>
        <div class="error" id="passwordError"></div>
    </div>

    <div class="form-group">
        <label class="required">Повторите пароль:</label>
        <input type="password" id="confirmPassword" required>
        <div class="error" id="confirmPasswordError"></div>
    </div>

    <button type="button" onclick="register()">Зарегистрироваться</button>
</form>

<p style="text-align: center; margin-top: 20px;">
    Уже есть аккаунт? <a href="/login.html">Войти</a>
</p>

<script>
    let isSubmitting = false;

    function register() {
        if (isSubmitting) return;

        const userData = {
            login: document.getElementById('login').value.trim(),
            username: document.getElementById('username').value.trim(),
            phoneNumber: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim() || null,
            password: document.getElementById('password').value,
            confirmPassword: document.getElementById('confirmPassword').value
        };

        // Очистка ошибок
        clearErrors();
        hideMessage();

        // Валидация
        let isValid = true;

        // Логин
        const loginPattern = /^[a-zA-Z0-9_]+$/;
        if (!userData.login || userData.login.length < 3) {
            showError('loginError', 'Логин должен быть не менее 3 символов');
            isValid = false;
        } else if (!loginPattern.test(userData.login)) {
            showError('loginError', 'Только латиница, цифры и подчеркивание');
            isValid = false;
        }

        // Телефон
        const phonePattern = /^\+[1-9]\d{1,14}$/;
        if (!userData.phoneNumber) {
            showError('phoneError', 'Номер телефона обязателен');
            isValid = false;
        } else if (!phonePattern.test(userData.phoneNumber)) {
            showError('phoneError', 'Формат: +79991234567');
            isValid = false;
        }

        // Email (опционально)
        if (userData.email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(userData.email)) {
                showError('emailError', 'Некорректный email');
                isValid = false;
            }
        }

        // Пароль
        if (!userData.password || userData.password.length < 6) {
            showError('passwordError', 'Пароль должен быть не менее 6 символов');
            isValid = false;
        }

        // Подтверждение пароля
        if (userData.password !== userData.confirmPassword) {
            showError('confirmPasswordError', 'Пароли не совпадают');
            isValid = false;
        }

        if (!isValid) return;

        // Убираем confirmPassword перед отправкой
        delete userData.confirmPassword;

        // Блокируем кнопку
        isSubmitting = true;
        const button = document.querySelector('button');
        const originalText = button.textContent;
        button.textContent = 'Регистрация...';
        button.disabled = true;

        // Отправка
        fetch('/api/v1/users/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(userData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Ошибка регистрации');
                    });
                }
                return response.json();
            })
            .then(data => {
                showMessage('Регистрация успешна! Теперь войдите в систему.', 'success');
                document.getElementById('registerForm').reset();

                // Автопереход через 3 секунды
                setTimeout(() => {
                    window.location.href = '/login.html?registered=true';
                }, 3000);
            })
            .catch(error => {
                const errorText = error.message.toLowerCase();

                if (errorText.includes('логин')) {
                    showError('loginError', error.message);
                } else if (errorText.includes('телефон') || errorText.includes('номер')) {
                    showError('phoneError', error.message);
                } else if (errorText.includes('email') || errorText.includes('почт')) {
                    showError('emailError', error.message);
                } else {
                    showMessage(error.message, 'error');
                }
            })
            .finally(() => {
                isSubmitting = false;
                button.textContent = originalText;
                button.disabled = false;
            });
    }

    function clearErrors() {
        document.querySelectorAll('.error').forEach(el => {
            el.textContent = '';
        });
    }

    function showError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
        }
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';
    }

    function hideMessage() {
        document.getElementById('message').style.display = 'none';
    }

    // Маска для телефона
    document.addEventListener('DOMContentLoaded', function() {
        const phoneInput = document.getElementById('phone');

        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value.length > 0) {
                if (value.startsWith('8')) {
                    value = '7' + value.substring(1);
                }
                if (!value.startsWith('7')) {
                    value = '7' + value;
                }
                e.target.value = '+' + value;

                // Ограничиваем длину
                if (value.length > 11) {
                    e.target.value = '+' + value.substring(0, 11);
                }
            }
        });

        // Автофокус на логин
        document.getElementById('login').focus();

        // Обработка параметра registered
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('registered')) {
            showMessage('Регистрация успешна! Теперь войдите в систему.', 'success');
            window.history.replaceState({}, '', '/auth.html');
        }
    });
</script>
</body>
</html>